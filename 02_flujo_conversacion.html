<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>ChatAssist - Flow Builder</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#38e07b",
                        "background-light": "#f6f8f7",
                        "background-dark": "#122017"
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
        
        /* Estilos para SortableJS */
        .sortable-ghost {
            opacity: 0.3;
            background: rgba(56, 224, 123, 0.15) !important;
            border: 2px dashed #38e07b !important;
            transform: none !important;
        }
        
        .sortable-chosen {
            cursor: grabbing !important;
        }
        

        
        /* Smooth animations */
        .flow-step {
            transition: all 0.3s ease;
        }
        
        .flow-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Drag handle cursor */
        .drag-handle {
            cursor: grab;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">
    <div class="flex flex-col min-h-screen">
        <header class="border-b border-gray-200/50 dark:border-gray-700/50">
            <div class="container mx-auto px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 text-primary">
                        <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">ChatAssist</h1>
                </div>
            </div>
        </header>
        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="max-w-4xl mx-auto">
                <div class="mb-12">
                    <h2 class="text-4xl font-bold tracking-tight text-slate-900 dark:text-white">Definición de Pasos del Flujo</h2>
                    <p class="mt-2 text-lg text-slate-600 dark:text-slate-400">
                        Define los pasos de la conversación. Puedes arrastrar y soltar los pasos para reorganizar su orden.
                    </p>
                </div>
                <div class="space-y-8">
                    <div>
                        <div id="flow-steps" class="space-y-2">
                            <!-- Los pasos se generarán dinámicamente aquí -->
                        </div>
                        <div class="mt-6">
                            <button id="add-step-btn" class="w-full flex items-center justify-center gap-2 h-12 px-6 rounded-lg bg-primary/10 hover:bg-primary/20 dark:bg-primary/20 dark:hover:bg-primary/30 text-primary font-semibold transition-colors">
                                <span class="material-symbols-outlined">add_circle</span>
                                Añadir Paso
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-12 pt-8 border-t border-primary/20 flex justify-end gap-4">
                    <button class="h-11 px-6 rounded-lg bg-background-light dark:bg-background-dark border border-slate-300 dark:border-slate-700 text-slate-700 dark:text-slate-300 font-semibold hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                        Cancelar
                    </button>
                    <a href="03_configuracion_asistencia.html" id="save-flow-btn" class="h-11 px-6 rounded-lg bg-primary text-slate-900 font-bold shadow-md hover:shadow-lg hover:brightness-105 transition-all">
                        Guardar Flujo
                    </a>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Datos JSON de los pasos del flujo
        let flowSteps = [
            {
                id: 1,
                title: "Paso 1: Inicio",
                description: "Mensaje de bienvenida y opciones iniciales",
                icon: "chat_bubble",
                order: 1
            },
            {
                id: 2,
                title: "Paso 2: Selección de Producto",
                description: "Pregunta sobre el tipo de producto deseado",
                icon: "help_outline",
                order: 2
            },
            {
                id: 3,
                title: "Paso 3: Confirmación de Pedido",
                description: "Confirmación del pedido y detalles de pago",
                icon: "check_circle",
                order: 3
            },
            {
                id: 4,
                title: "Paso 4: Finalización",
                description: "Mensaje de agradecimiento y próximos pasos",
                icon: "sentiment_satisfied",
                order: 4
            }
        ];

        let sortable = null;

        // Función para renderizar los pasos
        function renderFlowSteps() {
            const container = document.getElementById('flow-steps');
            container.innerHTML = '';

            // Ordenar los pasos por su orden
            const sortedSteps = flowSteps.sort((a, b) => a.order - b.order);

            sortedSteps.forEach((step, index) => {
                const stepElement = createStepElement(step, index);
                container.appendChild(stepElement);
            });

            // Inicializar o reinicializar SortableJS
            initializeSortable();
        }

        // Función para crear un elemento de paso
        function createStepElement(step, index) {
            const div = document.createElement('div');
            div.className = 'flow-step flex items-center justify-between p-4 rounded-lg bg-white dark:bg-slate-900/50 shadow-sm border border-slate-200 dark:border-slate-800 transition-all duration-200';
            div.dataset.stepId = step.id;

            div.innerHTML = `
                <div class="flex items-center gap-4">
                    <span class="drag-handle material-symbols-outlined text-slate-400 dark:text-slate-500 hover:text-primary transition-colors">drag_indicator</span>
                    <div class="w-12 h-12 rounded-lg bg-primary/10 dark:bg-primary/20 flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary text-3xl">${step.icon}</span>
                    </div>
                    <div>
                        <p class="font-semibold text-slate-900 dark:text-white">${step.title}</p>
                        <p class="text-sm text-slate-500 dark:text-slate-400">${step.description}</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button class="edit-btn w-10 h-10 flex items-center justify-center rounded-full hover:bg-primary/10 dark:hover:bg-primary/20 text-slate-500 dark:text-slate-400 hover:text-primary transition-colors">
                        <span class="material-symbols-outlined">edit</span>
                    </button>
                    <button class="delete-btn w-10 h-10 flex items-center justify-center rounded-full hover:bg-red-500/10 text-slate-500 dark:text-slate-400 hover:text-red-500 transition-colors">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </div>
            `;

            // Event listeners para botones
            div.querySelector('.edit-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                editStep(step.id);
            });
            div.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteStep(step.id);
            });

            return div;
        }

        // Inicializar SortableJS
        function initializeSortable() {
            const container = document.getElementById('flow-steps');
            
            // Destruir instancia anterior si existe
            if (sortable) {
                sortable.destroy();
            }

            sortable = new Sortable(container, {
                handle: '.drag-handle',
                animation: 300,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                forceFallback: false,
                swapThreshold: 0.65,
                direction: 'vertical',
                
                onEnd: function(evt) {
                    
                    // Actualizar el orden en el array
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    
                    if (oldIndex !== newIndex) {
                        // Mover el elemento en el array
                        const movedStep = flowSteps.splice(oldIndex, 1)[0];
                        flowSteps.splice(newIndex, 0, movedStep);
                        
                        // Actualizar los órdenes
                        flowSteps.forEach((step, index) => {
                            step.order = index + 1;
                        });
                        
                        // Actualizar títulos para reflejar el nuevo orden
                        updateStepTitles();
                        
                        console.log('Nuevo orden:', flowSteps.map(s => s.title));
                    }
                }
            });
        }

        // Actualizar títulos de pasos para reflejar el orden actual
        function updateStepTitles() {
            flowSteps.forEach((step, index) => {
                // Extraer el nombre del paso sin el número
                const titleWithoutNumber = step.title.replace(/^Paso \d+:\s*/, '');
                step.title = `Paso ${index + 1}: ${titleWithoutNumber}`;
            });
            
            // Re-renderizar solo los títulos sin reinicializar todo
            const stepElements = document.querySelectorAll('.flow-step');
            stepElements.forEach((element, index) => {
                const titleElement = element.querySelector('p.font-semibold');
                if (titleElement) {
                    titleElement.textContent = flowSteps[index].title;
                }
            });
        }

        // Función para editar un paso
        function editStep(stepId) {
            const step = flowSteps.find(s => s.id === stepId);
            if (step) {
                const currentTitle = step.title.replace(/^Paso \d+:\s*/, '');
                const newTitle = prompt('Nuevo título del paso:', currentTitle);
                if (newTitle && newTitle.trim()) {
                    const stepIndex = flowSteps.findIndex(s => s.id === stepId);
                    step.title = `Paso ${stepIndex + 1}: ${newTitle.trim()}`;
                    
                    const newDescription = prompt('Nueva descripción:', step.description);
                    if (newDescription && newDescription.trim()) {
                        step.description = newDescription.trim();
                        renderFlowSteps();
                    }
                }
            }
        }

        // Función para eliminar un paso
        function deleteStep(stepId) {
            if (confirm('¿Estás seguro de que quieres eliminar este paso?')) {
                flowSteps = flowSteps.filter(step => step.id !== stepId);
                // Reordenar los pasos restantes
                flowSteps.forEach((step, index) => {
                    step.order = index + 1;
                });
                updateStepTitles();
                renderFlowSteps();
            }
        }

        // Función para añadir un nuevo paso
        function addStep() {
            const title = prompt('Título del nuevo paso:');
            if (title && title.trim()) {
                const description = prompt('Descripción del paso:');
                if (description && description.trim()) {
                    const newStep = {
                        id: Date.now(),
                        title: `Paso ${flowSteps.length + 1}: ${title.trim()}`,
                        description: description.trim(),
                        icon: "help_outline",
                        order: flowSteps.length + 1
                    };
                    flowSteps.push(newStep);
                    renderFlowSteps();
                }
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            renderFlowSteps();
            
            document.getElementById('add-step-btn').addEventListener('click', addStep);
            document.getElementById('save-flow-btn').addEventListener('click', saveFlow);
        });

        // Funciones de utilidad para exportar/importar
        function exportFlow() {
            const dataStr = JSON.stringify(flowSteps, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'flow-configuration.json';
            link.click();
        }

        function importFlow(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedSteps = JSON.parse(e.target.result);
                        if (Array.isArray(importedSteps)) {
                            flowSteps = importedSteps;
                            renderFlowSteps();
                            alert('Configuración importada exitosamente!');
                        }
                    } catch (error) {
                        alert('Error al importar el archivo: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }
    </script>

</body>

</html>